C51 COMPILER V9.60.0.0   MAIN                                                              07/03/2021 16:28:23 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings\main.lst) OBJEC
                    -T(.\Objects\main.obj)

line level    source

   1          /**
   2           * æŒ‰é”®è¯´æ˜ï¼š
   3           * â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”   â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”
   4           * â”‚1â”‚2â”‚3â”‚Aâ”‚ â†’ â”‚1â”‚2â”‚3â”‚+â”‚
   5           * â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤   â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤
   6           * â”‚4â”‚5â”‚6â”‚Bâ”‚ â†’ â”‚4â”‚5â”‚6â”‚-â”‚
   7           * â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤   â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤
   8           * â”‚7â”‚8â”‚9â”‚Câ”‚ â†’ â”‚7â”‚8â”‚9â”‚Ã—â”‚
   9           * â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤   â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤
  10           * â”‚*â”‚0â”‚#â”‚Dâ”‚ â†’ â”‚â†â”‚0â”‚=â”‚Ã·â”‚
  11           * â””â”€â”´â”€â”´â”€â”´â”€â”˜   â””â”€â”´â”€â”´â”€â”´â”€â”˜
  12           * å…ˆæŒ‰ # å†æŒ‰ 0 è¡¨ç¤º AC
  13           */
  14          
  15          #include <regx52.h>
  16          #include <intrins.h>
  17          #include <stdio.h>
  18          #include "buzzer.h"
  19          #include "delay.h"
  20          #include "lcd1602.h"
  21          #include "matrixkey.h"
  22          #include "str.h"
  23          #include "timer0.h"
  24          #include "calc.h"
  25          
  26          #define alertBeep beepTime(880, 500)
  27          #define alertBeepShort beepTime(880, 250)
  28          #define alertBeepError beepTime(440, 1000)
  29          
  30          //unsigned char cursor = 1;
  31          char symbols[] = " 1234567890+-*/";
  32          char input[17];
  33          
  34          void showCursor(bit show) {
  35   1              unsigned char pos = str_getLength(input) + 1;
  36   1              LCD_ShowChar(1, pos, show ? '_' : ' ');
  37   1      }
  38          
  39          void main() {
  40   1              unsigned char keyNum;
  41   1              alertBeep;
  42   1              LCD_Init();
  43   1              
  44   1              LCD_ShowString(1, 1, "Calculator");
  45   1              LCD_ShowString(2, 1, "   + - * / =    ");
  46   1              delay(1000);
  47   1      
  48   1              LCD_ClearLine(2);
  49   1              LCD_ShowString(1, 1, "1900100324");
  50   1              LCD_ShowString(2, 1, "WangChenYi"); // ç‹æ™¨æ‡¿
  51   1              delay(1000);
  52   1      
  53   1              LCD_ShowString(1, 1, "1900100327");
  54   1              LCD_ShowString(2, 1, "XueHan    "); // è–›æ¶µ
C51 COMPILER V9.60.0.0   MAIN                                                              07/03/2021 16:28:23 PAGE 2   

  55   1              delay(1000);
  56   1              
  57   1              LCD_WriteCommand(0x01);
  58   1              timer0Init(); // ä¹‹ååˆå§‹åŒ–å®šæ—¶å™¨ 0ï¼Œè¦ä¸ç„¶ä¸€å¯åŠ¨å°±èƒ½æ˜¾ç¤ºå…‰æ ‡äº†
  59   1              showCursor(1);
  60   1              
  61   1              while (1) {
  62   2                      unsigned char len = str_getLength(input);
  63   2                      bit ac = 0; // å½’é›¶æŒ‡ç¤ºæ ‡å¿—ä½
  64   2                      keyNum = MatrixKey();
  65   2                      if (keyNum) {
  66   3                              if (!startTimer0 && keyNum <= 10) {
  67   4                                      input[0] = '\0';
  68   4                                      len = 0;
  69   4                                      if (keyNum == 10) ac = 1;
  70   4                              }
  71   3                              startTimer0 = 1;
  72   3                              if (keyNum <= 14) { // é™¤ * # é”®å¤–
  73   4                                      #define syntaxError {\
  74   4                                              alertBeepError;\
  75   4                                              continue;\
  76   4                                      }
  77   4                                      if (len >= 16) syntaxError // è¶…è¿‡å±å¹•æœ€å¤§ 16 ä½é™åº¦
  78   4                                      else {
  79   5                                              if (keyNum >= 11) { // + - * /
  80   6                                                      if (symbols[keyNum] == '+' || symbols[keyNum] == '*' || symbols[keyNum] == '/') {
  81   7                                                              if (
  82   7                                                                      len == 0 // åœ¨å¼€å¤´è¾“å…¥é™¤è´Ÿå·å¤–çš„ç¬¦å·
  83   7                                                                      || len == 1 && input[len - 1] == '-' // åœ¨è´Ÿå·ä¹‹åè¾“å…¥ç¬¦å·ï¼ˆå¼€å¤´ï¼‰
  84   7                                                                      || len > 1 && input[len - 1] == '-' && (input[len - 2] == '+' || input[len - 2] == '*' || input[le
             -n - 2] == '/') // åœ¨è´Ÿå·ä¹‹åè¾“å…¥ç¬¦å·ï¼ˆä¸­é—´ï¼‰
  85   7                                                              ) syntaxError
  86   7                                                              if (input[len - 1] == '+' || input[len - 1] == '-' || input[len - 1] == '*' || input[len - 1] == '/
             -') str_removeLast(input); // å¯ä»¥æ›´æ”¹ç¬¦å·
  87   7                                                      } else if (symbols[keyNum] == '-') { // å‡å·äº¦å¯ç”¨ä½œè´Ÿå·
  88   7                                                              if (len == 1 && (input[len - 1] == '+' || input[len - 1] == '-' || input[len - 1] == '*' || input[l
             -en - 1] == '/')) syntaxError // åœ¨è´Ÿå·ä¹‹åè¾“å…¥ç¬¦å·
  89   7                                                              if (len > 1 && (input[len - 1] == '+' || input[len - 1] == '-')) str_removeLast(input); // å¯ä»¥æ›
             -´æ”¹ç¬¦å·
  90   7                                                      }
  91   6                                              }
  92   5                                              if (!ac) str_appendChar(input, symbols[keyNum]);
  93   5                                      }
  94   4                              }
  95   3                              if (keyNum == 15) { // â†
  96   4                                      str_removeLast(input); // æ¸…é™¤æœ«ä½
  97   4                              }
  98   3                              if (keyNum == 16) { // =
  99   4                                      double result;
 100   4                                      char result_str[17];
 101   4                                      if (input[0] == '\0') continue;
 102   4                                      while (input[str_getLength(input) - 1] < '0') str_removeLast(input); // æ¸…é™¤æœ«å°¾å¤šä½™çš„ç¬¦å·
 103   4                                      result = calc(input);
 104   4                                      sprintf(result_str, "%g", result); // ä¸ºä»€ä¹ˆä¸ç”¨ %16gï¼Ÿå› ä¸ºè¿™æ ·å†™å½“å…¶ä¸ºç§‘å­¦è®¡æ•°æ³•æ—
             -¶ä¼šå‡ºç°ä½æ•°çš„ bug
 105   4                                      str_rightAlign(result_str, 16);
 106   4                                      LCD_ShowString(2, 1, result_str);
 107   4                                      startTimer0 = 0;
 108   4                              }
 109   3                              LCD_ClearLine(1);
 110   3                              LCD_ShowString(1, 1, input); // æ›´æ–°æ˜¾ç¤ºå±ï¼Œæ¦‚ç‡æ€§ä¼šé”™ä½
 111   3                              if (keyNum == 10) { // 0
C51 COMPILER V9.60.0.0   MAIN                                                              07/03/2021 16:28:23 PAGE 3   

 112   4                                      if (len > 0 && input[len - 1] == '/') { // å¦‚æœé™¤ä»¥ 0
 113   5                                              startTimer0 = 0;
 114   5                                              LCD_ShowString(2, 1, "Error ");
 115   5                                              alertBeepError;
 116   5                                              str_removeLast(input);
 117   5                                              LCD_ClearLine(1);
 118   5                                              LCD_ShowString(1, 1, input);
 119   5                                              LCD_ClearLine(2);
 120   5                                              startTimer0 = 1;
 121   5                                              showCursor(1);
 122   5                                      }
 123   4                              }
 124   3                              showCursor(1);
 125   3                              alertBeepShort;
 126   3                      }
 127   2              }
 128   1      }
 129          
 130          void timer0Routine() interrupt 1 {
 131   1              static unsigned int T0Count;
 132   1              static bit timeSetFlashFlag = 1; // æ˜¾ç¤ºå…‰æ ‡æŒ‡ç¤ºå™¨
 133   1              TL0 = 0x18; // è®¾ç½®å®šæ—¶åˆå€¼
 134   1              TH0 = 0xFC; // è®¾ç½®å®šæ—¶åˆå€¼
 135   1              T0Count++;
 136   1              if (T0Count >= 500) { // æ¯ 500ms è¿›å…¥ä¸€æ¬¡
 137   2                      T0Count = 0;
 138   2                      timeSetFlashFlag = !timeSetFlashFlag; // å…‰æ ‡æŒ‡ç¤ºå™¨åè½¬
 139   2                      showCursor(timeSetFlashFlag);
 140   2              }
 141   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    830    ----
   CONSTANT SIZE    =     82    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     35      23
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       2
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
